 # .pre-commit-config.yaml
repos:

  # ── General hygiene ──────────────────────────────────────────────────────
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
        args: [--allow-multiple-documents]
      - id: check-toml
      - id: check-json
      - id: check-merge-conflict
      - id: check-case-conflict
      - id: detect-private-key          # catch accidentally committed API keys
      - id: check-added-large-files
        args: [--maxkb=500]             # block large data files / model artifacts
      - id: no-commit-to-branch
        args: [--branch, main, --branch, prod]
      - id: check-symlinks
      - id: mixed-line-ending

  # ── Secrets / credentials ─────────────────────────────────────────────────
  # Critical for a repo with broker API keys, DB creds, fund params
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args: [--baseline, .secrets.baseline]
        exclude: tests/fixtures/

  # - repo: https://github.com/trufflesecurity/trufflehog
  #   rev: v3.93.4
  #   hooks:
  #     - id: trufflehog
  #       name: TruffleHog (high-entropy secret scan)
  #       entry: trufflehog git file://. --since-commit HEAD --only-verified --fail
  #       language: system
  #       pass_filenames: false

  # ── Python formatting ─────────────────────────────────────────────────────
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.15.2
    hooks:
      - id: ruff                        # linting (replaces flake8, isort, pyupgrade)
        args: [--fix]
      - id: ruff-format                 # formatting (replaces black)

  # ── Type checking ─────────────────────────────────────────────────────────
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.19.1
    hooks:
      - id: mypy
        additional_dependencies:
          - pandas-stubs
          - types-PyYAML
          - types-requests
        # Strict for risk/execution — do not relax
        args: [--strict, --ignore-missing-imports]
        files: ^(risk|execution|portfolio)/

  # ── Security / SAST ───────────────────────────────────────────────────────
  - repo: https://github.com/PyCQA/bandit
    rev: 1.9.3
    hooks:
      - id: bandit
        args: [-c, pyproject.toml]
        # High severity only — avoid noise in research code
        additional_dependencies: ["bandit[toml]"]

  # ── YAML / config validation ──────────────────────────────────────────────
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.38.0
    hooks:
      - id: yamllint
        args: [-d, relaxed]
        files: \.(yaml|yml)$

  # Custom: validate asset_universe.yaml and fund_params.yaml schemas
  - repo: local
    hooks:
      - id: validate-config-schemas
        name: Validate fund config schemas
        entry: python scripts/validate_configs.py
        language: python
        files: ^config/.*\.(yaml|yml)$
        pass_filenames: true

  # ── Jupyter notebooks ─────────────────────────────────────────────────────
  # Research notebooks often bleed into this repo; strip output before commit
  - repo: https://github.com/kynan/nbstripout
    rev: 0.9.1
    hooks:
      - id: nbstripout
        args: [--keep-count, --keep-output]  # strip but keep cell count

  - repo: https://github.com/nbQA-dev/nbQA
    rev: 1.9.1
    hooks:
      - id: nbqa-ruff
      - id: nbqa-mypy

  # ── SQL (storage/ schemas) ────────────────────────────────────────────────
  - repo: https://github.com/sqlfluff/sqlfluff
    rev: 4.0.4
    hooks:
      - id: sqlfluff-lint
        files: ^infrastructure/data/storage/.*\.sql$
        args: [--dialect, ansi]
      - id: sqlfluff-fix
        files: ^infrastructure/data/storage/.*\.sql$
        args: [--dialect, ansi]

  # ── Markdown / docs ───────────────────────────────────────────────────────
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.47.0
    hooks:
      - id: markdownlint
        args: [--fix]
        files: docs/

  # ── Dependency / supply chain ─────────────────────────────────────────────
  - repo: local
    hooks:
      - id: pip-audit
        name: pip-audit (CVE scan on dependencies)
        entry: pip-audit --strict --vulnerability-service pypi
        language: python
        additional_dependencies: [pip-audit]
        pass_filenames: false
        stages: [pre-push]               # only on push — slower
